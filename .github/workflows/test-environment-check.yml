name: Test Environment Check

on:
  workflow_dispatch:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

jobs:
  environment-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Display repository structure
        run: |
          echo "🏗️ Repository Structure Check"
          echo "================================"
          echo ""
          echo "📋 All branches:"
          git branch -a
          echo ""
          echo "🏷️ All tags:"
          git tag --list
          echo ""
          echo "📊 Commit history (graph view):"
          git log --oneline --graph --all -10
          echo ""
          echo "📁 Project files:"
          find . -type f -name "*.js" -o -name "*.yml" -o -name "*.md" | head -20
          echo ""
          echo "🎯 Test scenarios ready:"
          echo "1. Create hotfix from v0.1.0 → should propagate to v0.1.1, main, dev"
          echo "2. Create hotfix from v0.1.1 → should propagate to main, dev"
          echo ""
          echo "🚀 Available workflows:"
          echo "- Create Hotfix Branch"
          echo "- Auto Merge Hotfix"
          echo "- Test Environment Check (this one)"
          
      - name: Validate branch structure
        run: |
          echo "🔍 Validating branch structure..."
          
          # Check required branches exist
          required_branches=("main" "dev" "release/v0.1.0" "release/v0.1.1")
          for branch in "${required_branches[@]}"; do
            if git show-ref --verify --quiet refs/remotes/origin/$branch || git show-ref --verify --quiet refs/heads/$branch; then
              echo "✅ Branch '$branch' exists"
            else
              echo "❌ Branch '$branch' missing"
              exit 1
            fi
          done
          
          # Check required tags exist
          required_tags=("v0.1.0" "v0.1.1")
          for tag in "${required_tags[@]}"; do
            if git tag --list | grep -q "^$tag$"; then
              echo "✅ Tag '$tag' exists"
            else
              echo "❌ Tag '$tag' missing"
              exit 1
            fi
          done
          
          echo "🎉 All required branches and tags are present!"
          
      - name: Test file structure
        run: |
          echo "📁 Testing file structure..."
          
          # Check required files
          required_files=("src/index.js" "package.json")
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "✅ File '$file' exists"
            else
              echo "❌ File '$file' missing"
              exit 1
            fi
          done
          
          echo "🎉 All required files are present!"
          
      - name: Summary
        run: |
          echo "📋 Environment Check Summary"
          echo "============================"
          echo "✅ Repository structure: PASSED"
          echo "✅ Branch validation: PASSED" 
          echo "✅ Tag validation: PASSED"
          echo "✅ File structure: PASSED"
          echo ""
          echo "🚀 Ready for propagate-merger testing!"