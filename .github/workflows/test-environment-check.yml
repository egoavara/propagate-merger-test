name: Test Environment Check

on:
  workflow_dispatch:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

jobs:
  environment-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Display repository structure
        run: |
          echo "ğŸ—ï¸ Repository Structure Check"
          echo "================================"
          echo ""
          echo "ğŸ“‹ All branches:"
          git branch -a
          echo ""
          echo "ğŸ·ï¸ All tags:"
          git tag --list
          echo ""
          echo "ğŸ“Š Commit history (graph view):"
          git log --oneline --graph --all -10
          echo ""
          echo "ğŸ“ Project files:"
          find . -type f -name "*.js" -o -name "*.yml" -o -name "*.md" | head -20
          echo ""
          echo "ğŸ¯ Test scenarios ready:"
          echo "1. Create hotfix from v0.1.0 â†’ should propagate to v0.1.1, main, dev"
          echo "2. Create hotfix from v0.1.1 â†’ should propagate to main, dev"
          echo ""
          echo "ğŸš€ Available workflows:"
          echo "- Create Hotfix Branch"
          echo "- Auto Merge Hotfix"
          echo "- Test Environment Check (this one)"
          
      - name: Validate branch structure
        run: |
          echo "ğŸ” Validating branch structure..."
          
          # Check required branches exist
          required_branches=("main" "dev" "release/v0.1.0" "release/v0.1.1")
          for branch in "${required_branches[@]}"; do
            if git show-ref --verify --quiet refs/remotes/origin/$branch || git show-ref --verify --quiet refs/heads/$branch; then
              echo "âœ… Branch '$branch' exists"
            else
              echo "âŒ Branch '$branch' missing"
              exit 1
            fi
          done
          
          # Check required tags exist
          required_tags=("v0.1.0" "v0.1.1")
          for tag in "${required_tags[@]}"; do
            if git tag --list | grep -q "^$tag$"; then
              echo "âœ… Tag '$tag' exists"
            else
              echo "âŒ Tag '$tag' missing"
              exit 1
            fi
          done
          
          echo "ğŸ‰ All required branches and tags are present!"
          
      - name: Test file structure
        run: |
          echo "ğŸ“ Testing file structure..."
          
          # Check required files
          required_files=("src/index.js" "package.json")
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… File '$file' exists"
            else
              echo "âŒ File '$file' missing"
              exit 1
            fi
          done
          
          echo "ğŸ‰ All required files are present!"
          
      - name: Summary
        run: |
          echo "ğŸ“‹ Environment Check Summary"
          echo "============================"
          echo "âœ… Repository structure: PASSED"
          echo "âœ… Branch validation: PASSED" 
          echo "âœ… Tag validation: PASSED"
          echo "âœ… File structure: PASSED"
          echo ""
          echo "ğŸš€ Ready for propagate-merger testing!"